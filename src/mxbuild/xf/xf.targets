<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
 
  <!--
    Nuget package

    Expected the layout of binaries and .xbf/.xr.xml files to be the same regardless
    of whether the reference is from a project or from nuget. Actually, nuget layout
    expects .xbf/.xr.xml files to be nested under a directory that matches the project 
    name. Seems something to do with AppxPriInitialPath in 
      C:\Program Files (x86)\MSBuild\Microsoft\VisualStudio\v14.0\AppxPackage\Microsoft.AppxPackage.Targets

    The following command will dump the resource binary index which contains its 
    expected layout of non-embeded resources like .xbf/.xr.xml
      makepri dump /if Xamarin.Forms.CarouselView.pri
  -->
  <!--Hack: nuget package consumers expect xbf and xr.xml in an AssemblyName subdir-->
  <ItemGroup>
    <WindowsResourceFile Include="$(OutDirAbsolute)$(AssemblyName).xr.xml" >
      <TargetDir>$(OutDirAbsolute)$(AssemblyName)\</TargetDir>
    </WindowsResourceFile>
  </ItemGroup>
  <Target
    Name="LayoutPackageToMatchPri"
    Condition="
      '$(MobilePlatform)' == '$(WindowsMobilePlatformId)' AND 
      '$(IsMobileLibraryProject)'=='true' AND
      '$(IsPartPlatform)'!='true' AND
      '$(IsPrimitivePlatform)'=='true'
    "
    Inputs="@(WindowsResourceFile)"
    Outputs="@(WindowsResourceFile->'%(TargetDir)')"
    AfterTargets="AfterBuild"
  >
    <ItemGroup>
      <!--resources.xbf "moves around" on various windows builds-->
      <WindowsResourceFile Include="$(OutDirAbsolute)windows\resources.xbf" >
        <TargetDir>$(OutDirAbsolute)$(AssemblyName)\windows\</TargetDir>
      </WindowsResourceFile>
      <WindowsResourceFile Include="$(OutDirAbsolute)resources.xbf" >
        <TargetDir>$(OutDirAbsolute)$(AssemblyName)\</TargetDir>
      </WindowsResourceFile>
      <WindowsResourceFile Condition="!Exists(%(WindowsResourceFile.FullPath))" Remove="%(Identity)" />
    </ItemGroup>
    
    <Message Importance="$(Verbosity)" Text="LayoutPackageToMatchPri [$(Configuration)|$(Plat)|$(MetaPlatform)]: $(OutDirAbsolute)"/>
    <Message Importance="$(Verbosity)" Text="  %(WindowsResourceFile.FileName)%(Extension) -> %(TargetDir)%(RecursiveDir)"/>

    <MakeDir Directories="%(WindowsResourceFile.TargetDir)" />
    <Copy 
      SourceFiles="%(WindowsResourceFile.Identity)" 
      DestinationFolder="%(TargetDir)%(RecursiveDir)" 
    />
  </Target>
</Project>